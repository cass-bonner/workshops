<html>
<meta>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="serverless.css" />
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
</meta>
<body background="images/background.png">
<script src="js/clipboard.js-master/dist/clipboard.min.js"></script>

    <script>
    var clipboard = new Clipboard('.btn');
    clipboard.on('success', function(e) {
        console.log(e);
    });
    clipboard.on('error', function(e) {
        console.log(e);
    });
    </script>

<table>
  <tr>
    <td align="left" width="25%"><img src="images/aws_icon.png"/></td>
    <td align = "center" width = "60%">
<font size="2">
  <table>
<tr>
<td width="100%"><a href="serverless_prerequisites.html">Serverless Workshop Prerequisites</a></td>
</tr>
<tr>
<td width="100%"><a href="serverless.html">Serverless Overview</a><br/></td>
</tr>
<tr>
<td width="100%"><a href="serverless-static-website.html">Serverless Static Webabb</a><br/></td>
</tr>
<tr>
<td width="100%"><a href="serverless-dynamic-website.html">Serverless Dynamic Webapp</a><br/></td>
</tr>
<tr>
<td width="100%"><a href="serverless-chatbot.html">Serverless Lex Chatbot</a><br/></td>
</tr></table>
</font size="2">
    </td>
    <td align="right" width="25%"><img src="images/iag_icon.png"/></td>
 </tr>
</table>

<br/>
<br/>
<p ="font-family:verdana">
<h1 align="center">Serverless Chatbot on AWS</h1>
<table cellpadding="20px"  align="center">
<tr>
<td width="20%"><img src="images/lex.png"/><br/><a href="http://docs.aws.amazon.com/lex/latest/dg/what-is.html">Amazon Lex</a>
<td width="20%"><img src="images/polly.png"/><br/><a href="http://docs.aws.amazon.com/polly/latest/dg/what-is.html">Amazon Polly</a>
<td width="20%"><img src="images/s3.png"/><br/><a href="http://docs.aws.amazon.com/AmazonS3/latest/gsg/GetStartedWithS3.html">Amazon S3</a>
<td width="20%"><a href="http://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html"><img src="images/cognito.png"/><br/>Amazon Cognito</a>
<td width="20%"><img src="images/iam.png"/><br/><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/">AWS IAM</a>
</tr>
</table>

<h4>Amazon Lex</h4>

<ol>
<li><listing class="pretext">Now let's add a chat bot into our application.  AWS has a number of services in the AI space, one of which is Amazon Lex, an AWS service for building conversational interfaces for any applications using voice and text. With Amazon Lex, the same conversational engine that powers Amazon Alexa is now available to any developer, enabling you to build sophisticated, natural language chatbots into your new and existing applications. Amazon Lex provides the deep functionality and flexibility of natural language understanding (NLU) and automatic speech recognition (ASR) so you can build highly engaging user experiences with lifelike, conversational interactions, and create new categories of products. Lex uses specific terminolog - it identifies 'Intents' by analyzing 'Utterances', and then collects the required 'slot' values, and once all required slots are provided it 'Fulfills' the intent as shown in this diagram:

<a href="https://aws.amazon.com/lex/details/"><img src="images/lex-desc.png"/></a>

We're going to create a Lex Bot that invokes our same polling PetMatch Lambda Function for fullment and then include it on our site. Note that there are powerful use cases for Lex that allow you users to in a much more conversational style, and the value prop for Lex definitely includes allowing users to "navigate" to their desired "Intent" (all the different actions or insights they would like to perform on the website).  Lex can be used to help reduce the "friction" of navigating traditional websites. The use case here is a simple collection of data and is transactional in nature, but it is still useful to demonstrate Lex. Also, imagine that our PetMatch page was nested in our site about 4 "navigations" (clicks,nav bar navigation, etc), Lex could more directly identify and pre-populate data for an Intent.  
 

</listing>
</li>
<li><listing class="pretext">Navigate to the the 'Lex' Service in the AWS console. Lex is currently available in us-east-1 only so you will have to select that region. You'll see a 'Test Bot' at the bottom of the console - but this will not work until we've defined and buit the bot so let's get started. :)</listing></li>
<li><listing class="pretext">Select 'Create', and then 'Custom Bot'</listing></li>
<li><listing class="pretext">Use [yourid]PetMatcher for the Bot name and Select a voice of your liking. Then select 'Create'</listing></li>
<li><listing class="pretext">Select 'Create an intent', and then 'Create a new intent'.  Call it [yourid]pettypematch, and then select 'Add'.</listing></li>
<li><listing class="pretext">
In the Sample Utterances box, type 'Match My Pet Type'.

Select the + icon to add  the utterance as shown here:

<img src="images/lex-ui-create.png"/>

Repeat this process for the following phrases so that you have three utterances listed:
I want to match my pet type
Can you match my pet type
</listing></li>
<li><listing class="pretext">Skip over the 'Lambda Initialisation and validation', but be aware that you can invoke a Lambda function to initialize and validate as the slots are field. For example in our case we could invoke a Lambda function which get the list of questions or return the next question to ask, validating input,etc. We would only allow 'yes' or 'no' for many of the questions, and others are restricted to an enumeration.

</listing></li>
<li><listing class="pretext">Select the (+) icon to the near the 'Slot Type' by in the left navigation.  Fill in the details for a userIdYesNo slot type by first typing 'yes' into the box to the left of the + icon, and only after hitting the + icon or just hitting return. Repeat this for 'no' then say 'Save Slot Type'. Amazon Lex uses the enumeration values you provide in a slot type definition to train its <a href="http://docs.aws.amazon.com/lex/latest/dg/gl-guidelines.html">machine learning models</a>. 

<img src="images/slot-type-add.png"/>

</listing></li>
<li><listing class="pretext">Add another slot type called [yourUserId]AccommodationType and the enumeration values: house, apartment and townhouse.</listing></li>



<li><listing class="pretext">For the Slots, we're going to replicate the questions we asked on our PetMatch website because those are the values that we need to collect to be able to perform a match.</listing></li>
<li><listing class="pretext">Enter 'duress' for the Name and 'Do you feel that you are under stress' for the Prompt. Hit the + icon similar to how you added the Utterances.

Repeat the same for all the questions as follows, leaving the slot name exactly as shown with no capitals:

* Ensure that all of the Intents have the checkbox ticked.

Name: walks
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: Since you said {duress} to feeling stressed, does going for walks in the park change that?

Name: sass
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: Do you like to be around people that have an interesting, yet sassy character?

Name: travel
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: How many days per month do you travel 

Name: yap
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: Do you mind consistent yapping 

Name: accommodation
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: Do you live in an apartment or house 

Name: outside
Prompt Type: AMAZON.US_FIRST_NAME
Prompt: If you have an Outdoors area, how large is it in sq m? Say 0 if you do not have one 

It should look like this afterwords (except all should be required fields):

<img src="images/lex-slots.png"/>


</listing></li>
<li><listing class="pretext">Skip the confirmation prompt as the result of the pet match is not something that needs confirmed, and ensure the 'Fulfillment' is expanded. Choose 'AWS Lambda function' and in the drop down select your lambda function that invokes the state machine and gets the response. Once all the data is collected we'll use that same function to give us the result of the match.</listing></li>
<li><listing class="pretext">If your Lambda function is not listed because you created your Lambda in another region, then you can write a Lambda function in us-east-1 that calls your Lambda Function in the region you deployed it. See the instructions at the end of this page (Search for invokeLambdaOtherRegion) if that is relevant for you. </listing></li>
<li><listing class="pretext">Once your function is tested select 'Save Invent'</listing></li>
<li><listing class="pretext">Select 'Build' from the top of the page to the left of the 'Publish' button.</listing></li>
<li><listing class="pretext">Expand the bot to test your new intent by typing 'pet match' </listing></li>
<li><listing class="pretext">We've defined the Bot, but now we need to invoke our Lambda function which in turn calls Step Functions.</listing></li>

</ol>
<ol>

<h4> AWS Lambda Fulfillment Function</h4>
Now we're going to create a Lambda function that will perform the <a href="http://docs.aws.amazon.com/lex/latest/dg/using-lambda.html">fulfillment of our Intent</a>. We're going to use the same synchronous Lambda function that we used for the web page.  The Lambda function used with Amazon Lex has a specific format which you can read about at the above link. The easiest way to get started is to search for a Lambda Blueprint for 'Lex'.  For this lab we'll provide the code.
<li><listing class="pretext">Navigate to Lambda in the Console, and select 'Create a Lambda function'</listing></li>
<li><listing class="pretext">Select 'Blank Function' and skip the Trigger by hitting Next again.</listing></li>
<li><listing class="pretext">Name the Lambda function [yourid]invokeLambdaOtherRegion. Not that this is a type of utility function that can be genericised and re-used by all. However with the permissions setup for this lab to avoid accidental overwrite, you won't have permissions to do that.</listing></li>
<li><listing class="pretext">Paste the following into the body of your function.

<button class="btn btn-outline-secondary btn-sm" data-clipboard-target="#invlam">Copy</button>
	<pre><span id="invlam">
'use strict';

var aws = require('aws-sdk');
var lambda = new aws.Lambda({
  region: process.env.LAMBDA_REGION
});
 // --------------- Helpers to build responses which match the structure of the necessary dialog actions -----------------------

function elicitSlot(sessionAttributes, intentName, slots, slotToElicit, message) {
    return {
        sessionAttributes,
        dialogAction: {
            type: 'ElicitSlot',
            intentName,
            slots,
            slotToElicit,
            message,
        },
    };
}

function close(sessionAttributes, fulfillmentState, message) {
    return {
        sessionAttributes,
        dialogAction: {
            type: 'Close',
            fulfillmentState,
            message,
        },
    };
}

function delegate(sessionAttributes, slots) {
    return {
        sessionAttributes,
        dialogAction: {
            type: 'Delegate',
            slots,
        },
    };
}


function buildValidationResult(isValid, violatedSlot, messageContent) {
    if (messageContent === null) {
        return {
            isValid,
            violatedSlot,
        };
    }
    return {
        isValid,
        violatedSlot,
        message: { contentType: 'PlainText', content: messageContent },
    };
}


function handlePetMatch(intentRequest, callback,context) {
    
    // invoke our Lambda function to give us the resutMatch
    
    console.log("in handlePetMatch:  " + JSON.stringify(intentRequest));
    //for noe replace input with mock
    var mock = { 
      "duress" : "yes",
      "walks" : "yes",
      "sass" : "no",
      "travel" : 9,
      "yap" : "no",
      "accommodation" : "apartment",
      "outside" : 15
    }
    var params = {
      FunctionName: process.env.FUNCTION_NAME,
      Payload: JSON.stringify(mock, null, 2) 
    };
    console.log("params: "+ params);
    lambda.invoke(params, function(error, data) {
      if (error) {
          console.log("error occurred: " + error);
        context.done('error', error);
      }
      if(data){
        var json = JSON.parse(data.Payload) 
        console.log("data: " + json);
        var response = "Your Pet Match is a " + json.petTypeId + " of breed " +   
            json.breed + ". The pet is classified as a " + 
            json.Classification + " and the average life expectancy is " + json.lifespan;

       // Send the response back to ex
       callback(close(intentRequest.sessionAttributes, 'Fulfilled',
            { contentType: 'PlainText', content: response
            }));
      }
    });
  
}




 // --------------- Intents -----------------------

/**
 * Called when the user specifies an intent for this skill.
 */
function dispatch(intentRequest, callback, context) {
    console.log(`dispatch userId=${intentRequest.userId}, intentName=${intentRequest.currentIntent.name}`);

    
    console.log("intentRequest: " + JSON.stringify(intentRequest));
    const intentName = intentRequest.currentIntent.name;

    // Dispatch to your skill's intent handlers
    if (intentName === process.env.INTENT_NAME) {
        return handlePetMatch(intentRequest, callback);
    }
    throw new Error(`Intent with name ${intentName} not supported`);
}

// --------------- Main handler -----------------------

// Route the incoming request based on intent.
// The JSON body of the request is provided in the event slot.
exports.handler = (event, context, callback) => {
    try {
        // By default, treat the user request as coming from the America/New_York time zone.
        process.env.TZ = 'America/New_York';
        console.log(`event.bot.name=${event.bot.name}`);
        console.log('event=' + JSON.stringify(event));

        if (event.bot.name !== process.env.BOT_NAME) {
             callback('Invalid Bot Name: ' + event.bot.name);
        }
        
        dispatch(event, (response) => callback(null, response), context)
    } catch (err) {
        callback(err);
    }
};

</span></pre>


</listing></li>
<li><listing class="pretext">DEFINE two Environment Variables (below the function) substituting the appropriate region name and your function name. Note that ap-southeast-2 is Sydney, but you can search for any region <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">here</a>:

TARGET_REGION=ap-southeast-2
FUNCTION_NAME=[yourid]invokeSMAndPollForOutput
</listing></li>
<li><listing class="pretext"></listing></li>
</ol>

For role. TODO


<ol>
<li><listing class="pretext">Now we're going to "bootstrap" our efforts by using a lab off <a href="https://github.com/awslabs">awslabs on github</a>.
Navigate to <a href="https://github.com/awslabs/aws-lex-web-ui">this url</a> in your browser in a new tab:</listing></li>
<br/>

<button class="btn btn-outline-secondary btn-sm" data-clipboard-target="#lexwebui">Copy</button>
<pre><span id="lexwebui">https://github.com/awslabs/aws-lex-web-ui</span></pre>

</p
<br/>
<div class="image-blurred-edge"></div>
</div>
<br/>
<ol>
<li>Have a quick read of the architecture and then navigate to the section called 'Lauching'. Select the 'Launch Stack' Icon and which will take you to <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html">CloudFormation</a> in the AWS Console.  Ensure you are in the us-east-1 region.
<li>Copy the link where it says 'Specify an Amazon S3 template URL or click  <button class="btn btn-outline-secondary btn-sm" data-clipboard-text="https://s3.amazonaws.com/aws-bigdata-blog/artifacts/aws-lex-web-ui/artifacts/templates/master.yaml">Copy</button>
<br/>
<br/>

Enter that url into another browser tab and have a quick look at the CloudFormation template that creates the lab and try to understand and find the Services that will be launched.
<br/
<li><listing class="pretext"  Go back to the CloudFormation tab in your browser and click the Next button and be sure to <font color="red"CHANGE the STACKNAME</font>. Put your unique userId of your work login in front of the existing name so it looks something like this:

<pre>bonnerca-lex-web-ui</pre> 

Similarly with every paramter - preface it with your unique id. This will make it much easier to find your resources if we are all working in the same AWS account.</listing></li>
<li><listing class="pretext">For the BotName - don't use the default value -   change it to the name of your bot.</li> 

<li> Hit Next until the last page and select the 'I acknowledge that AWS CloudFormation might create IAM resources with custom names.' and click 'Create'
<li>This will take some time to build but in the meantime read through the rest of the awslabs write-up.
</ol>


<br/>
<br/>
  <a href="spark-backend"/>&lt;Now let's change our algorithm for the match&gt;</a>
</body>
</html>
